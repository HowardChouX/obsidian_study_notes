# 17.3 B树操作

---

## 高度与深度

二叉搜索树的高度和平均深度是决定其性能的重要属性。**高度**指最深叶节点的层级距离，是整棵树的性质；**深度**指特定节点到根节点的距离，是节点特有的性质。

**平均深度**指所有节点深度的算术平均值。

![](https://cs61b-2.gitbook.io/~gitbook/image?url=https%3A%2F%2F2316889115-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FCLYj7ccqvV6l4Pt9R0w5%252Fuploads%252Ffw0lImiVGDeoKO8llW4N%252Fimage.png%3Falt%3Dmedia%26token%3D4b6d11f4-8be6-40b0-9a21-23ba690d6f31&width=768&dpr=4&quality=100&sign=332a301d&sv=2)

二叉树的高度与深度示意图

---

## 实际应用中的BST

高度和平均深度决定了BST操作的运行时复杂度。高度决定了查找节点的最坏情况时间复杂度，平均深度决定了搜索操作的平均情况时间复杂度。

节点的插入顺序对BST的高度和平均深度有重大影响。例如依次插入`1, 2, 3, 4, 5, 6, 7`会形成高度为6、平均深度3的线型结构；若按`4, 2, 1, 3, 6, 5, 7`顺序插入，则得到高度2、平均深度1.43的平衡结构。

![](https://cs61b-2.gitbook.io/~gitbook/image?url=https%3A%2F%2F2316889115-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FCLYj7ccqvV6l4Pt9R0w5%252Fuploads%252Fc5XKSyCSyvmIQ1dLX9LE%252Fimage.png%3Falt%3Dmedia%26token%3D9caeeff5-d1f9-4017-a681-a03430cde7e4&width=768&dpr=4&quality=100&sign=9264734b&sv=2)

不同插入顺序导致的高度和深度变化

---

## 现实世界中的BST

在实际应用中，我们首先考虑随机化BST。随机生成的插入顺序平均具有$logN$高度和平均深度。数学证明显示期望深度$E[d]=2\ln N$，期望高度$E[h]=4.311\ln N$（证明超出本课程范围）。这些性质在插入和删除操作中均成立。

但现实场景中常无法随机化插入顺序（如实时流数据），因此需要新的方法来维持搜索树的"丛生性"。

---

## B树

### 避免失衡

核心思想是通过"超额装载"叶节点来延缓高度增长。当插入新值时，不新建节点而是暂存于现有叶节点：

![](https://cs61b-2.gitbook.io/~gitbook/image?url=https%3A%2F%2F2316889115-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FCLYj7ccqvV6l4Pt9R0w5%252Fuploads%252FettoJbVEr2tWqbpmWL5q%252Fimage.png%3Falt%3Dmedia%26token%3D159dd972-1b10-4436-bc27-f3b4ac505d40&width=768&dpr=4&quality=100&sign=5673c8fa&sv=2)

插入17时的超额装载

但这种方法会导致叶节点退化为线性列表，因此引入升级分裂机制：

![](https://cs61b-2.gitbook.io/~gitbook/image?url=https%3A%2F%2F2316889115-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FCLYj7ccqvV6l4Pt9R0w5%252Fuploads%252FYxIpM5WqTqOTjXJza7cQ%252Fimage.png%3Falt%3Dmedia%26token%3Da38bf577-a65b-41f9-a095-aab39460d238&width=768&dpr=4&quality=100&sign=b2566fc7&sv=2)

节点分裂示意图

设定节点容量上限$L$后，搜索时间复杂度仅增加常数因子（渐进复杂度不变）。插入操作可能引发级联分裂：

![](https://cs61b-2.gitbook.io/~gitbook/image?url=https%3A%2F%2F2316889115-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FCLYj7ccqvV6l4Pt9R0w5%252Fuploads%252F7FCDjQTVpQpUAPUHOZpF%252Fimage.png%3Falt%3Dmedia%26token%3D7ad9d434-9bb0-4830-a3d7-4ebb914b6811&width=768&dpr=4&quality=100&sign=91a72618&sv=2)

多级节点分裂过程

当根节点超限时，树高度必然增加：

![](https://cs61b-2.gitbook.io/~gitbook/image?url=https%3A%2F%2F2316889115-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FCLYj7ccqvV6l4Pt9R0w5%252Fuploads%252FHEbRIafnGJpNXCiDsaOY%252Fimage.png%3Falt%3Dmedia%26token%3D5d7d6a46-0559-4792-8188-5476bb30c78a&width=768&dpr=4&quality=100&sign=b471e7df&sv=2)

根节点超限示意图

![](https://cs61b-2.gitbook.io/~gitbook/image?url=https%3A%2F%2F2316889115-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FCLYj7ccqvV6l4Pt9R0w5%252Fuploads%252F9ab4KAoobVjitgxPNrSG%252Fimage.png%3Falt%3Dmedia%26token%3Da6efd59e-6fe4-4a26-a117-87001296b925&width=768&dpr=4&quality=100&sign=73ecf084&sv=2)

根节点分裂过程

---

### 完美平衡

这种分裂树数据结构具有完美平衡特性：根节点分裂时所有节点下移一级，叶节点或内部节点分裂时树高不变。该结构的正式名称为**B树**，节点容量为3时称为**2-3-4树**或**2-4树**，容量为2时称为**2-3树**。

---

### B树应用

B树主要应用于两个场景：
1. 小$L$值用于概念上的平衡搜索树
2. $L$值达数千量级时用于数据库和文件系统的大记录存储